

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Quickstart &mdash; deepr 2.4.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pipeline" href="pipeline.html" />
    <link rel="prev" title="DeepR reference documentation" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> deepr
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Dataset">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Prepro">Prepro</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model">Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Pred-function">Pred function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Loss-function">Loss function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Optimizer">Optimizer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Trainer-job">Trainer job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning.html">Hyper Parameter Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced</a></li>
</ul>
<p class="caption"><span class="caption-text">Developper documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">DeepR: Build and Train Deep Learning Pipelines for Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../API/core.html">DeepR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_source/modules.html">deepr</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">deepr</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Quickstart</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/getting_started/quickstart.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Quickstart">
<h1>Quickstart<a class="headerlink" href="#Quickstart" title="Permalink to this headline">¶</a></h1>
<p>This notebook is a gentle introduction to the few concepts and abstractions of deepr.</p>
<p>It demonstrates how to train a model that learns how to multiply a number by 2.</p>
<p>To train a model with deepr the main entry point is the <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.jobs.Trainer.html#deepr.jobs.Trainer">Trainer</a> job.</p>
<p>It is important at this point to stress that <code class="docutils literal notranslate"><span class="pre">deepr</span></code> is not yet another library to build neural networks, but merely a utility to build functions that operate on basic Tensorflow types, i.e. <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/Tensor">tf.Tensor</a> and <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset">tf.data.Dataset</a>.</p>
<p>Using functional programming makes it easy to lazily define graphs that will only be built at run time by the <a class="reference external" href="https://www.tensorflow.org/guide/estimator">tf.estimator</a> high-level API.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> job uses most of the <a class="reference external" href="https://criteo.github.io/deepr/API/core.html">important concepts</a> of deepr, while only expecting basic types (mainly functions operating on datasets, dictionaries of tensors, etc.).</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">path_model</span> <span class="pre">:</span> <span class="pre">str</span></code> Path to the model directory. Can be either local or HDFS.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pred_fn</span> <span class="pre">:</span> <span class="pre">Callable[[Dict[str,</span> <span class="pre">tf.Tensor],</span> <span class="pre">str],</span> <span class="pre">Dict[str,</span> <span class="pre">tf.Tensor]]</span></code> Typically a <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.layers.Layer.html#deepr.layers.Layer">Layer</a> instance, but in general, any callable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">loss_fn</span> <span class="pre">:</span> <span class="pre">Callable[[Dict[str,</span> <span class="pre">tf.Tensor],</span> <span class="pre">str],</span> <span class="pre">Dict[str,</span> <span class="pre">tf.Tensor]]</span></code> Typically a <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.layers.Layer.html#deepr.layers.Layer">Layer</a> instance, but in general, any callable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">optimizer_fn</span> <span class="pre">:</span> <span class="pre">Callable[[tf.Tensor],</span> <span class="pre">tf.Tensor]</span></code> Typically an <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.optimizers.Optimizer.html#deepr.optimizers.Optimizer">Optimizer</a> instance, but in general, any callable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train_input_fn</span> <span class="pre">:</span> <span class="pre">Callable[[],</span> <span class="pre">tf.data.Dataset]</span></code> Typically a <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.readers.Reader.html#deepr.readers.Reader">Reader</a> instance, but in general, any callable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eval_input_fn</span> <span class="pre">:</span> <span class="pre">Callable[[],</span> <span class="pre">tf.data.Dataset]</span></code> Typically a <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.readers.Reader.html#deepr.readers.Reader">Reader</a> instance, but in general, any callable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prepro_fn:</span> <span class="pre">Callable[[tf.data.Dataset,</span> <span class="pre">str],</span> <span class="pre">tf.data.Dataset],</span> <span class="pre">Optional</span></code> Typically a <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.prepros.Prepro.html#deepr.prepros.Prepro">Prepro</a> instance, but in general, any callable.</p></li>
</ul>
<p>There are more parameters that use the other concepts (hooks, metrics, exporter, …) and this will be covered in another guide.</p>
<p>So to train our model, we need to define all that, let’s start !</p>
<div class="section" id="Dataset">
<h2>Dataset<a class="headerlink" href="#Dataset" title="Permalink to this headline">¶</a></h2>
<p>The first step is to build a dataset. For this we will build a synthetic dataset of numbers of (x, 2x).</p>
<p>Also see other ways to build a dataset in the <a class="reference external" href="https://criteo.github.io/deepr/API/core.html#reader">reader reference</a></p>
<p>Some imports first</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">deepr</span> <span class="k">as</span> <span class="nn">dpr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">dpr</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">dpr</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_dir</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Let’s define a generator function and then use a <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.readers.GeneratorReader.html#deepr.readers.GeneratorReader">GeneratorReader</a> to create a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">generator_fn</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">}</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">GeneratorReader</span><span class="p">(</span>
    <span class="n">generator_fn</span><span class="p">,</span>
    <span class="n">output_types</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">},</span>
    <span class="n">output_shapes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:(),</span> <span class="s2">&quot;y&quot;</span><span class="p">:()}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Reader</span></code> classes are simple helper functions to create <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>, heavily inspired by the <code class="docutils literal notranslate"><span class="pre">tensorflow_dataset</span></code> package.</p>
<p>Once the reader is configured, you can create a new <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> with</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">as_dataset</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">reader</span><span class="p">()</span>  <span class="c1"># Simply an alias for as_dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;DatasetV1Adapter shapes: {x: (), y: ()}, types: {x: tf.float32, y: tf.float32}&gt;
&lt;DatasetV1Adapter shapes: {x: (), y: ()}, types: {x: tf.float32, y: tf.float32}&gt;
</pre></div></div>
</div>
<p>Iterating over a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> in “graph” mode is not possible.</p>
<p>The base <code class="docutils literal notranslate"><span class="pre">Reader</span></code> class makes it possible to iterate over the dataset, faking eager-execution mode (under the hood it simply creates a session in the special <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method).</p>
<p>Let’s have a look at the content of our dataset</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;x&#39;: 0.026452266, &#39;y&#39;: 0.05290453}
{&#39;x&#39;: 0.22739638, &#39;y&#39;: 0.45479277}
{&#39;x&#39;: 0.5724985, &#39;y&#39;: 1.144997}
{&#39;x&#39;: 0.403317, &#39;y&#39;: 0.806634}
{&#39;x&#39;: 0.21341616, &#39;y&#39;: 0.42683232}
{&#39;x&#39;: 0.83121186, &#39;y&#39;: 1.6624237}
{&#39;x&#39;: 0.3990266, &#39;y&#39;: 0.7980532}
{&#39;x&#39;: 0.7587566, &#39;y&#39;: 1.5175132}
{&#39;x&#39;: 0.24581175, &#39;y&#39;: 0.4916235}
{&#39;x&#39;: 0.40846375, &#39;y&#39;: 0.8169275}
{&#39;x&#39;: 0.27732524, &#39;y&#39;: 0.5546505}
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> job expects 2 <code class="docutils literal notranslate"><span class="pre">input_fn</span></code> that are simple callables creating new <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">reader</span></code> does exactly that, so let’s set</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_input_fn</span> <span class="o">=</span> <span class="n">reader</span>
<span class="n">eval_input_fn</span> <span class="o">=</span> <span class="n">reader</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Prepro">
<h2>Prepro<a class="headerlink" href="#Prepro" title="Permalink to this headline">¶</a></h2>
<p>Now that we have datasets, we need to preprocess them before feeding data to our model. In this example, we only need to create batches of data, and allow multiple iterations over the dataset to be able to perform multiple epochs.</p>
<p>Let’s use the <code class="docutils literal notranslate"><span class="pre">prepro</span></code> module to functionally define a preprocessing function.</p>
<p>See the <a class="reference external" href="https://criteo.github.io/deepr/API/core.html#prepro">prepro reference</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prepro_fn</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">.</span><span class="n">prepros</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
    <span class="n">dpr</span><span class="o">.</span><span class="n">prepros</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">),</span>
    <span class="n">dpr</span><span class="o">.</span><span class="n">prepros</span><span class="o">.</span><span class="n">Repeat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>As expected, the output of this prepro function is a batched dataset</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prepro_fn</span><span class="p">(</span><span class="n">reader</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;DatasetV1Adapter shapes: {x: (?,), y: (?,)}, types: {x: tf.float32, y: tf.float32}&gt;
</pre></div></div>
</div>
<p>Let’s check the result of our preprocessing by iterating over the dataset. We use the helper function <code class="docutils literal notranslate"><span class="pre">from_dataset</span></code> that creates a <code class="docutils literal notranslate"><span class="pre">reader</span></code> from any <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>, which gives us eager-like iteration over the underlying dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dpr</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span><span class="n">prepro_fn</span><span class="p">(</span><span class="n">reader</span><span class="p">())):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;x&#39;: array([8.38533640e-01, 5.11415541e-01, 4.91451062e-02, 6.71378195e-01,
       7.19314665e-02, 2.07208991e-01, 6.07405782e-01, 2.14489564e-01,
       1.24138966e-01, 5.16671121e-01, 2.33591374e-04, 3.69159013e-01,
       3.05574089e-01, 9.81275201e-01, 4.54333931e-01, 3.23030204e-01,
       6.02127731e-01, 2.13016793e-01, 8.41403484e-01, 6.13585055e-01,
       1.33147994e-02, 6.54389381e-01, 8.09324920e-01, 5.17527759e-01,
       2.62713879e-01, 2.71976054e-01, 4.55039740e-01, 2.46606708e-01,
       8.55176270e-01, 2.10764825e-01, 9.98475403e-02, 1.92478955e-01],
      dtype=float32), &#39;y&#39;: array([1.6770673e+00, 1.0228311e+00, 9.8290212e-02, 1.3427564e+00,
       1.4386293e-01, 4.1441798e-01, 1.2148116e+00, 4.2897913e-01,
       2.4827793e-01, 1.0333422e+00, 4.6718275e-04, 7.3831803e-01,
       6.1114818e-01, 1.9625504e+00, 9.0866786e-01, 6.4606041e-01,
       1.2042555e+00, 4.2603359e-01, 1.6828070e+00, 1.2271701e+00,
       2.6629599e-02, 1.3087788e+00, 1.6186498e+00, 1.0350555e+00,
       5.2542776e-01, 5.4395211e-01, 9.1007948e-01, 4.9321342e-01,
       1.7103525e+00, 4.2152965e-01, 1.9969508e-01, 3.8495791e-01],
      dtype=float32)}
</pre></div></div>
</div>
</div>
<div class="section" id="Model">
<h2>Model<a class="headerlink" href="#Model" title="Permalink to this headline">¶</a></h2>
<p>Now that we have a preprocessed dataset, let’s build the model.</p>
<p>The dataset yields dictionaries of tensors.</p>
<p>The model is made of 2 main components</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pred_fn(tensors:</span> <span class="pre">Dict,</span> <span class="pre">mode)</span> <span class="pre">-&gt;</span> <span class="pre">Dict</span></code> operates on the dataset dictionaries, creates new tensors (the predictions).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">loss_fn(tensors:</span> <span class="pre">Dict,</span> <span class="pre">mode)</span> <span class="pre">-&gt;</span> <span class="pre">Dict</span></code> operates on the dataset and <code class="docutils literal notranslate"><span class="pre">pred_fn</span></code> results, creates at least one new tensor <code class="docutils literal notranslate"><span class="pre">loss</span></code>.</p></li>
</ol>
<p>We’re going to use the <code class="docutils literal notranslate"><span class="pre">layer</span></code> module to quickly define those functions.</p>
<p>Make sure to check the <a class="reference external" href="https://criteo.github.io/deepr/API/core.html#layer">layer reference</a> for more information.</p>
<div class="section" id="Pred-function">
<h3>Pred function<a class="headerlink" href="#Pred-function" title="Permalink to this headline">¶</a></h3>
<p>The first part of the model is the prediction function.</p>
<p>Here it’s pretty simple : it will predict a <code class="docutils literal notranslate"><span class="pre">y_pred</span></code> with an <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter such that <code class="docutils literal notranslate"><span class="pre">y_pred</span> <span class="pre">=</span> <span class="pre">alpha</span> <span class="pre">*</span> <span class="pre">x</span></code></p>
<p>We first define this as a <code class="docutils literal notranslate"><span class="pre">Multiply</span></code> layer :</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@dpr</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">n_in</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Multiply</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">tensors</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">layer</span></code> decorator creates a <code class="docutils literal notranslate"><span class="pre">Layer</span></code> class from the function, roughly equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Multiply</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_in</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_in</span> <span class="o">=</span> <span class="n">n_in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_out</span> <span class="o">=</span> <span class="n">n_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_as_dict</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">tensors</span>

    <span class="k">def</span> <span class="nf">forward_as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">])}</span>
</pre></div>
</div>
<p>We can instantiate our <code class="docutils literal notranslate"><span class="pre">Layer</span></code> with</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pred_fn</span> <span class="o">=</span> <span class="n">Multiply</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;y_pred&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The power of the base <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.layers.Layer.html#deepr.layers.Layer">Layer</a> class is that layers are actually functions that can operate on both dictionaries and tuples of tensors.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">outputs</span></code> arguments, when given, specify the keys of the dictionaries to use for the layer.</p>
<p>Let’s see how it works</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_fn</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)))</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>  <span class="c1"># Remove alpha variable from the graph</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_fn</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)}))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Tensor(&#34;mul:0&#34;, shape=(), dtype=float32)
{&#39;y_pred&#39;: &lt;tf.Tensor &#39;mul:0&#39; shape=() dtype=float32&gt;}
</pre></div></div>
</div>
<p>Let’s check the output of this model (alpha is initialized randomly) :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pred_fn</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.6913518
</pre></div></div>
</div>
</div>
<div class="section" id="Loss-function">
<h3>Loss function<a class="headerlink" href="#Loss-function" title="Permalink to this headline">¶</a></h3>
<p>Let’s then define the loss function. A squared l2 loss will work fine here, let’s create a layer for this :</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@dpr</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">n_in</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SquaredL2</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">tensors</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">SquaredL2</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;y_pred&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s see if it works :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">((</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">({</span><span class="s2">&quot;y_pred&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)})))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.25
{&#39;loss&#39;: 0.25}
</pre></div></div>
</div>
</div>
<div class="section" id="Optimizer">
<h3>Optimizer<a class="headerlink" href="#Optimizer" title="Permalink to this headline">¶</a></h3>
<p>The last thing we need is the optimizer. See the <a class="reference external" href="https://criteo.github.io/deepr/API/core.html#optimizer">optimizer reference</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">optimizer_fn</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">TensorflowOptimizer</span><span class="p">(</span><span class="s2">&quot;Adam&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Trainer-job">
<h2>Trainer job<a class="headerlink" href="#Trainer-job" title="Permalink to this headline">¶</a></h2>
<p>Since all these concepts are now defined, let’s create a <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> job.</p>
<p>Make sure to check the <a class="reference external" href="https://criteo.github.io/deepr/API/_autosummary/deepr.jobs.Trainer.html#deepr.jobs.Trainer">trainer reference</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">job</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">path_model</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
    <span class="n">pred_fn</span><span class="o">=</span><span class="n">pred_fn</span><span class="p">,</span>
    <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span>
    <span class="n">optimizer_fn</span><span class="o">=</span><span class="n">optimizer_fn</span><span class="p">,</span>
    <span class="n">train_input_fn</span><span class="o">=</span><span class="n">train_input_fn</span><span class="p">,</span>
    <span class="n">eval_input_fn</span><span class="o">=</span><span class="n">eval_input_fn</span><span class="p">,</span>
    <span class="n">prepro_fn</span><span class="o">=</span><span class="n">prepro_fn</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Creating the job is lazy and doesn’t take any time. To run it, call the run method :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
INFO:deepr.prepros.core:Not applying Repeat(10) (mode=eval)
INFO:deepr.jobs.trainer:Running final evaluation, using global_step = 320
INFO:deepr.prepros.core:Not applying Repeat(10) (mode=eval)
INFO:deepr.jobs.trainer:{&#39;loss&#39;: 2.5611915e-12, &#39;global_step&#39;: 320}
</pre></div></div>
</div>
<p>The loss is 0, great, we now know how to multiply by 2 :)</p>
<p>Let’s check alpha is indeed equal to 2 :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">experiment</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">create_experiment</span><span class="p">()</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">estimator</span>
<span class="nb">print</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">get_variable_value</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2.0000005
</pre></div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="pipeline.html" class="btn btn-neutral float-right" title="Pipeline" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="DeepR reference documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Criteo

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>